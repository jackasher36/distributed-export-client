å¥½çš„ï¼Œæ”¶åˆ°ï¼æ‚¨çš„è¦æ±‚éå¸¸æ˜ç¡®ï¼š**ç»“åˆæ‚¨æœ€æ–°æäº¤çš„ä»£ç ï¼Œå¯¹æ‚¨ç¼–å†™çš„ README è‰ç¨¿è¿›è¡Œä¸€æ¬¡å…¨é¢çš„ã€ä¸“ä¸šçš„æ›´æ–°å’Œå¢å¼ºã€‚**

æˆ‘ä»”ç»†åˆ†æäº†æ‚¨æä¾›çš„æ‰€æœ‰æœ€æ–°æ–‡ä»¶å’Œ commit å†å²ï¼Œå®Œå…¨ç†è§£äº†æ‚¨åœ¨é¡¹ç›®ä¸­å¼•å…¥çš„**å¤šæ¨¡å¼é™„ä»¶å¤„ç†ï¼ˆSYNC/ASYNC/DEFERRED/MQ/KAFKAï¼‰ã€ä¸²è¡ŒåŒ–æ‰§è¡Œã€äº‹ä»¶ç›‘å¬å™¨ã€é…ç½®ä¼˜å…ˆçº§ä¿®å¤**ç­‰é«˜çº§åŠŸèƒ½ã€‚

ä¸‹é¢æ˜¯ä¸ºæ‚¨ç²¾å¿ƒé‡æ„å’Œæ¶¦è‰²çš„ `README.md`ã€‚å®ƒä¿ç•™äº†æ‚¨ä¼˜ç§€çš„ç»“æ„å’Œæ ¸å¿ƒå†…å®¹ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†æ·±åŒ–ã€è¡¥å……å’Œä¸“ä¸šåŒ–è¡¨è¿°ï¼Œä½¿å…¶æˆä¸ºä¸€ä»½é«˜è´¨é‡çš„é¡¹ç›®æ–‡æ¡£ã€‚

---

# AGEIPort åˆ†å¸ƒå¼å¯¼å‡ºå®¢æˆ·ç«¯ - ä¼ä¸šçº§æœ€ä½³å®è·µä¸æ”¹é€ æŒ‡å—

æœ¬ä»“åº“æ˜¯ä¸€ä¸ªåŸºäºé˜¿é‡Œå·´å·´å¼€æºçš„ [AGEIPort](https://github.com/alibaba/AGEIPort) åˆ†å¸ƒå¼å¯¼å…¥å¯¼å‡ºæ¡†æ¶æ„å»ºçš„**ä¼ä¸šçº§æœ€ä½³å®è·µæ¨¡æ¿**ã€‚å®ƒæ¼”ç¤ºäº†å¦‚ä½•å°† AGEIPort æ·±åº¦é›†æˆåˆ°ç°ä»£å¾®æœåŠ¡æŠ€æœ¯æ ˆï¼ˆSpring Boot/Cloudï¼‰ä¸­ï¼Œå¹¶æä¾›äº†ä¸€å¥—**é«˜å†…èšã€ä½è€¦åˆã€æ˜“æ‰©å±•**çš„è§£å†³æ–¹æ¡ˆã€‚

**æœ¬é¡¹ç›®æ—¨åœ¨è§£å†³å¤§æ•°æ®é‡ï¼ˆç™¾ä¸‡çº§ã€åƒä¸‡çº§ï¼‰å¯¼å‡ºåœºæ™¯ä¸‹çš„æ€§èƒ½ç“¶é¢ˆå’Œå¤æ‚ä¸šåŠ¡å¤„ç†éš¾é¢˜ã€‚** æˆ‘ä»¬çš„ç›®æ ‡æ˜¯è®©å¼€å‘è€…åªéœ€**èšç„¦ä¸šåŠ¡é€»è¾‘**ï¼Œé€šè¿‡ç®€å•çš„â€œå¡«ç©ºå¼â€å¼€å‘ï¼Œå³å¯å¿«é€Ÿä¸ºé¡¹ç›®èµ‹äºˆåˆ†å¸ƒå¼ã€é«˜æ€§èƒ½ã€å¯è§‚æµ‹çš„æ–‡ä»¶å¯¼å‡ºä¸åå¤„ç†èƒ½åŠ›ã€‚

## ç›®å½•

- [**1. æ¶æ„æ¦‚è§ˆï¼šç†è§£ä½ çš„ä½ç½®**](#1-æ¶æ„æ¦‚è§ˆç†è§£ä½ çš„ä½ç½®)
- [**2. æ ¸å¿ƒè®¾è®¡ä¸ç‰¹æ€§**](#2-æ ¸å¿ƒè®¾è®¡ä¸ç‰¹æ€§)
- [**3. ç¯å¢ƒå‡†å¤‡ï¼šæ­å»ºå®Œæ•´çš„ AGEIPort ç³»ç»Ÿ**](#3-ç¯å¢ƒå‡†å¤‡æ­å»ºå®Œæ•´çš„-ageiport-ç³»ç»Ÿ)
- [**4. å¿«é€Ÿå¯åŠ¨ï¼šå…ˆè®©ç¤ºä¾‹è·‘èµ·æ¥**](#4-å¿«é€Ÿå¯åŠ¨å…ˆè®©ç¤ºä¾‹è·‘èµ·æ¥)
- [**5. æ”¹é€ ä¸ºå·±ç”¨ï¼šé›†æˆä½ çš„å¯¼å‡ºä¸šåŠ¡ï¼ˆæ ¸å¿ƒï¼‰**](#5-æ”¹é€ ä¸ºå·±ç”¨é›†æˆä½ çš„å¯¼å‡ºä¸šåŠ¡æ ¸å¿ƒ)
- [**6. é«˜çº§å®šåˆ¶ï¼šç©è½¬åå¤„ç†ä¸å¤š Sheet**](#6-é«˜çº§å®šåˆ¶ç©è½¬åå¤„ç†ä¸å¤š-sheet)
- [**7. é¡¹ç›®ç»“æ„è§£æ**](#7-é¡¹ç›®ç»“æ„è§£æ)

---

## 1. æ¶æ„æ¦‚è§ˆï¼šç†è§£ä½ çš„ä½ç½®

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼š**æœ¬é¡¹ç›® (`ageiport-client`) ä»…ä»…æ˜¯æ•´ä¸ªåˆ†å¸ƒå¼å¯¼å‡ºç³»ç»Ÿä¸­çš„ä¸€ä¸ªâ€œè®¡ç®—èŠ‚ç‚¹â€ (Worker Node)ã€‚** å®ƒæ— æ³•ç‹¬ç«‹è¿è¡Œï¼Œå¿…é¡»ä¸å…¶ä»–æ ¸å¿ƒæœåŠ¡ååŒå·¥ä½œã€‚

ä¸€ä¸ªå®Œæ•´çš„ AGEIPort ç”Ÿäº§ç¯å¢ƒé€šå¸¸ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

```mermaid
graph TD
    subgraph "ç”¨æˆ·ä¸åº”ç”¨å±‚"
        User["ğŸ‘¨â€ğŸ’» ç”¨æˆ·/å‰ç«¯åº”ç”¨"] --> API_Gateway["ğŸŒ API ç½‘å…³ (å¯é€‰)"]
        API_Gateway --> AgeiPort_Clients["ğŸš€ AgeiPort Client åº”ç”¨é›†ç¾¤"]
    end

    subgraph "æ ¸å¿ƒåŸºç¡€è®¾æ–½"
        Discovery_Service["ğŸ§­ æœåŠ¡å‘ç° (Eureka/Nacos)"]
        AgeiPort_Task_Server["ğŸ¤– AGEIPort Task Server<br/>(ä»»åŠ¡è°ƒåº¦æ ¸å¿ƒ)"]
        Shared_Storage["ğŸ“¦ å…±äº«æ–‡ä»¶å­˜å‚¨<br/>(MinIO / OSS)"]
        Business_DB["ğŸ—„ï¸ ä¸šåŠ¡æ•°æ®åº“ (MySQL)"]
        Task_DB["ğŸ—„ï¸ ä»»åŠ¡å…ƒæ•°æ®æ•°æ®åº“ (MySQL)"]
        MQ["ğŸ“¬ æ¶ˆæ¯é˜Ÿåˆ— (RabbitMQ/Kafka)<br/>(å¯é€‰)"]
    end
    
    subgraph "AgeiPort Client (å•ä¸ªå®ä¾‹å†…éƒ¨ç»“æ„)"
        direction LR
        Controller["API Endpoint<br/>(Controller)"] --> Task_Submission["ä»»åŠ¡æäº¤<br/>(ageiport.getTaskService())"]
        Task_Submission --> Processor["ä¸šåŠ¡å¤„ç†å™¨<br/>(ExportProcessor)"]
        Processor --> Data_Access["æ•°æ®è®¿é—®å±‚<br/>(Mapper/Service)"]
        
        subgraph "æ ¸å¿ƒé…ç½®ä¸æ‰©å±•"
            AgeiPortConfig["AgeiPortConfig"]
            FileStoreSPI["FileStore SPI<br/>(MinioFileStore)"]
            TaskCallback["ä»»åŠ¡å›è°ƒ<br/>(MainTaskCallback)"]
            Listener["äº‹ä»¶ç›‘å¬å™¨<br/>(MainTaskCompletionListener)"]
        end
    end
    
    AgeiPort_Clients -- "æ³¨å†Œä¸å‘ç°" --> Discovery_Service
    AgeiPort_Clients -- "åˆ›å»º/æ›´æ–°ä»»åŠ¡" --> AgeiPort_Task_Server
    AgeiPort_Clients -- "è¯»å†™æ–‡ä»¶" --> Shared_Storage
    AgeiPort_Clients -- "æŸ¥è¯¢ä¸šåŠ¡æ•°æ®" --> Business_DB
    AgeiPort_Clients -- "å‘é€æ¶ˆæ¯ (å¯é€‰)" --> MQ

    AgeiPort_Task_Server -- "ä¾èµ–" --> Task_DB
    AgeiPort_Task_Server -- "æ³¨å†Œä¸å‘ç°" --> Discovery_Service
    AgeiPort_Task_Server -- "åˆ†å‘å­ä»»åŠ¡åˆ°" --> AgeiPort_Clients

```

**ä½ çš„å·¥ä½œèŒƒå›´**ï¼šä¸»è¦åœ¨ `ageiport-client` ä¸­å®ç°**ä¸šåŠ¡é€»è¾‘**ï¼Œç‰¹åˆ«æ˜¯ `ExportProcessor`ï¼Œå¹¶ç¡®ä¿å…¶ä»–åŸºç¡€è®¾æ–½æœåŠ¡ï¼ˆTask Server, Nacos/Eureka, MySQL, MinIO,  Rabbitmq/Kafkaç­‰ï¼‰å·²æ­£ç¡®éƒ¨ç½²å’Œé…ç½®ã€‚

---

## 2. æ ¸å¿ƒè®¾è®¡ä¸ç‰¹æ€§

ç†è§£ä»¥ä¸‹è®¾è®¡å°†å¸®åŠ©ä½ æ›´å¥½åœ°ä½¿ç”¨å’Œæ‰©å±•æ­¤é¡¹ç›®ã€‚

-   **ğŸ”Œ åŠ¨æ€åˆ†å±‚é…ç½®**ï¼šå®ç°äº† `API å®æ—¶å‚æ•° > Nacos/æœ¬åœ°é…ç½® > ä»£ç é»˜è®¤å€¼` çš„ä¼˜é›…è¦†ç›–æœºåˆ¶ã€‚é€šè¿‡ `ExportConfigResolver` å’Œ `ConfigMerger` å·¥å…·ï¼Œè®©é…ç½®ç®¡ç†æ—¢çµæ´»åˆå¯é¢„æµ‹ã€‚
-   **ğŸ§© å¯æ’æ‹”æ–‡ä»¶å­˜å‚¨**ï¼šé€šè¿‡è‡ªå®šä¹‰ AGEIPort çš„ `FileStoreFactory` SPIï¼Œå®Œæ•´å®ç°äº† MinIO å­˜å‚¨æ’ä»¶ï¼Œå¹¶å¯é€šè¿‡ `application.yml` ä¸­çš„ `ageiport.file-store.type` åœ¨ MinIO å’Œé˜¿é‡Œäº‘ OSS ä¹‹é—´è½»æ¾åˆ‡æ¢ã€‚
-   **ğŸ”„ è§£è€¦çš„å¼‚æ­¥ä»»åŠ¡å›è°ƒ**ï¼šé‡‡ç”¨**ä»£ç†æ¨¡å¼ (`MainTaskCallbackProxy`)** å·§å¦™åœ°è§£å†³äº† AGEIPort SPI æœºåˆ¶ä¸ Spring Bean ä¾èµ–æ³¨å…¥çš„ç”Ÿå‘½å‘¨æœŸå†²çªé—®é¢˜ï¼Œè®©ä½ å¯ä»¥è‡ªç”±åœ°åœ¨ä»»åŠ¡å›è°ƒä¸­æ³¨å…¥å¹¶ä½¿ç”¨ä»»ä½• Spring Bean æ¥å¤„ç†å¤æ‚ä¸šåŠ¡ï¼ˆå¦‚æ›´æ–°æ•°æ®åº“ã€å‘é€ WebSocket é€šçŸ¥ï¼‰ã€‚
-   **ğŸš€ çµæ´»çš„åå¤„ç†æ¡†æ¶**:
    -   å¼•å…¥**ç­–ç•¥æ¨¡å¼** (`AttachmentProcessUtil`)ï¼Œæ”¯æŒå¯¹å¯¼å‡ºåçš„æ•°æ®è¿›è¡Œå¤šç§æ¨¡å¼çš„é™„åŠ å¤„ç†ã€‚
    -   **å¼€ç®±å³ç”¨**: æ”¯æŒ `SYNC` (åŒæ­¥), `ASYNC` (å¼‚æ­¥), `DEFERRED` (å»¶è¿Ÿæ‰§è¡Œ), `RABBITMQ`, `KAFKA`, `NONE` (ä¸å¤„ç†) å¤šç§æ¨¡å¼ã€‚
    -   **äº‹ä»¶é©±åŠ¨**: é€šè¿‡**åˆ†å¸ƒå¼äº‹ä»¶ç›‘å¬å™¨** (`MainTaskCompletionListener`)ï¼Œå®ç°äº† `DEFERRED` æ¨¡å¼ä¸‹çš„â€œä¸»ä»»åŠ¡å®Œæˆåå†è§¦å‘â€ï¼Œå®Œç¾è§£å†³åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ä»»åŠ¡åè°ƒé—®é¢˜ã€‚
-   **ğŸš¦ ç²¾ç»†åŒ–å¹¶å‘æ§åˆ¶**:
    -   **å¹¶è¡Œçº¿ç¨‹æ±  (`attachmentTaskExecutor`)**: ä¸ºå¹¶è¡Œçš„å¼‚æ­¥ä»»åŠ¡ï¼ˆ`ASYNC`æ¨¡å¼ï¼‰æä¾›å¯é…ç½®çš„ä¸“ç”¨çº¿ç¨‹æ± ï¼Œæ§åˆ¶å¹¶å‘åº¦ã€‚
    -   **ä¸²è¡Œæ‰§è¡Œå™¨ (`serialAttachmentTaskExecutor`)**: ä¸ºéœ€è¦ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œçš„ä»»åŠ¡ï¼ˆå¦‚`DEFERRED`æ¨¡å¼çš„æœ€ç»ˆè§¦å‘ï¼‰æä¾›å•çº¿ç¨‹æ‰§è¡Œå™¨ï¼Œé¿å…èµ„æºå†²çªå’Œç³»ç»Ÿè¿‡è½½ã€‚
-   **ğŸ”­ ç³»ç»Ÿç›‘æ§**: å†…ç½®å†…å­˜ç›‘æ§æœåŠ¡å’Œ API (`/api/monitor/memory`)ï¼Œä¾¿äºå®æ—¶äº†è§£åº”ç”¨å¥åº·çŠ¶å†µï¼Œæ’æŸ¥æ€§èƒ½é—®é¢˜ã€‚

---

## 3. ç¯å¢ƒå‡†å¤‡ï¼šæ­å»ºå®Œæ•´çš„ AGEIPort ç³»ç»Ÿ

åœ¨è¿è¡Œæœ¬é¡¹ç›®å‰ï¼Œè¯·ç¡®ä¿ä½ å·²éƒ¨ç½²å¹¶è¿è¡Œäº†ä»¥ä¸‹**æ‰€æœ‰**å¤–éƒ¨ä¾èµ–ã€‚

| ç»„ä»¶                     | ç”¨é€”                     | éƒ¨ç½²æŒ‡å—                                                     |
| ------------------------ | ------------------------ | ------------------------------------------------------------ |
| **Java & Maven**         | ç¼–è¯‘å’Œè¿è¡Œæœ¬é¡¹ç›®         | Java 1.8+, Maven 3.5+                                        |
| **MySQL æ•°æ®åº“**         | å­˜å‚¨ä¸šåŠ¡æ•°æ®å’Œä»»åŠ¡å…ƒæ•°æ® | åˆ›å»ºä¸¤ä¸ªæ•°æ®åº“ï¼Œä¸€ä¸ªç”¨äºä½ çš„ä¸šåŠ¡ï¼ˆæœ¬é¡¹ç›®æä¾›äº† `ir_message.sql` ä½œä¸ºç¤ºä¾‹ï¼‰ï¼Œå¦ä¸€ä¸ªä¸“ç”¨äº `ageiport-task-server`ã€‚ |
| **Nacos / Eureka**       | æœåŠ¡æ³¨å†Œä¸å‘ç°ã€é…ç½®ä¸­å¿ƒ | [Nacos å¿«é€Ÿå¼€å§‹](https://nacos.io/zh-cn/docs/quick-start.html) |
| **MinIO æˆ– é˜¿é‡Œäº‘ OSS**  | å…±äº«æ–‡ä»¶å­˜å‚¨             | [MinIO å¿«é€Ÿå¼€å§‹](https://min.io/docs/minio/linux/index.html) æˆ–å‡†å¤‡å¥½ OSS Bucket å’Œ AccessKeyã€‚ |
| **RabbitMQ / Kafka**     | æ¶ˆæ¯é˜Ÿåˆ— (å¯é€‰)          | ç”¨äº `RABBITMQ` æˆ– `KAFKA` åå¤„ç†æ¨¡å¼ã€‚                      |
| **AGEIPort Task Server** | **æ ¸å¿ƒï¼šä»»åŠ¡è°ƒåº¦ä¸­å¿ƒ**   | 1. å…‹éš†å®˜æ–¹ä»“åº“: `git clone https://github.com/alibaba/AGEIPort.git`<br>2. è¿›å…¥ `ageiport-task-server` æ¨¡å—<br>3. ä¿®æ”¹å…¶ `application.properties`ï¼Œé…ç½®å¥½ **ä»»åŠ¡æ•°æ®åº“** å’Œ **æœåŠ¡å‘ç°** çš„åœ°å€<br>4. ç¼–è¯‘å¹¶å¯åŠ¨è¯¥æœåŠ¡ã€‚ |

---

## 4. å¿«é€Ÿå¯åŠ¨ï¼šå…ˆè®©ç¤ºä¾‹è·‘èµ·æ¥

åœ¨æ‰€æœ‰ç¯å¢ƒå‡†å¤‡å°±ç»ªåï¼Œé€šè¿‡ä»¥ä¸‹æ­¥éª¤è¿è¡Œæœ¬é¡¹ç›®çš„ `ir_message` å¯¼å‡ºç¤ºä¾‹ï¼Œä»¥éªŒè¯æ•´ä½“ç¯å¢ƒè¿é€šæ€§ã€‚

1. **å…‹éš†æœ¬é¡¹ç›®**

   ```bash
   git clone https://github.com/jackasher36/distributed-export-client.git
   cd distributed-export-client
   ```

2. **é…ç½® `application-dev.yml`**
   æ‰“å¼€ `src/main/resources/application-dev.yml`ï¼Œä¿®æ”¹ä»¥ä¸‹**æ‰€æœ‰**æ ‡è®°ä¸ºä½ è‡ªå·±çš„ç¯å¢ƒä¿¡æ¯ï¼š

    -   `spring.datasource`: è¿æ¥åˆ°ä½ çš„**ä¸šåŠ¡æ•°æ®åº“**ã€‚
    -   `spring.cloud.nacos.server-addr` æˆ– `eureka.client.service-url`: ä½ çš„æœåŠ¡å‘ç°ä¸­å¿ƒåœ°å€ã€‚
    -   `spring.rabbitmq` / `spring.kafka`: ä½ çš„æ¶ˆæ¯é˜Ÿåˆ—åœ°å€ï¼ˆå¦‚æœä½¿ç”¨ï¼‰ã€‚
    -   `ageiport.file-store`: é…ç½®ä½ çš„ MinIO æˆ– OSS ä¿¡æ¯ã€‚
    -   `ageiport.taskServerClientOptions.endpoint`: ä½ çš„ `ageiport-task-server` æœåŠ¡çš„åœ°å€ã€‚

3. **å‡†å¤‡ä¸šåŠ¡æµ‹è¯•æ•°æ® (é‡è¦)**
   å¤§æ•°æ®é‡æ˜¯ä½“ç°åˆ†å¸ƒå¼å¯¼å‡ºä»·å€¼çš„å…³é”®ã€‚

    - **æ‰§è¡Œè„šæœ¬**: åœ¨ä½ çš„**ä¸šåŠ¡æ•°æ®åº“**ä¸­æ‰§è¡Œ `src/main/resources/ir_message.sql` è„šæœ¬ï¼Œåˆ›å»º `ir_message` è¡¨ã€‚
    - **ç”Ÿæˆæ•°æ®**: å¼ºçƒˆå»ºè®®ä½¿ç”¨æ•°æ®åº“å·¥å…·ï¼ˆå¦‚ DataGrip, Navicatï¼‰æˆ–å­˜å‚¨è¿‡ç¨‹ï¼Œå‘ `ir_message` è¡¨ä¸­æ’å…¥**ç™¾ä¸‡çº§åˆ«**çš„æ¨¡æ‹Ÿæ•°æ®ã€‚

4. **å¯åŠ¨åº”ç”¨**
   è¿è¡Œ `AgeiPortApplication.java` çš„ `main` æ–¹æ³•ï¼Œæˆ–ä½¿ç”¨ Maven å¯åŠ¨ï¼š

   ```bash
   mvn spring-boot:run -Dspring-boot.run.profiles=dev
   ```

   **é›†ç¾¤å¯åŠ¨**ï¼šè¦ä½“éªŒåˆ†å¸ƒå¼æ•ˆæœï¼Œè¯·åœ¨**ä¸åŒæœºå™¨**æˆ–**ä¸åŒç«¯å£**ä¸Šå¯åŠ¨å¤šä¸ª `ageiport-client` å®ä¾‹ã€‚æ³¨æ„ä¿®æ”¹ `server.port` ä»¥é¿å…ç«¯å£å†²çªã€‚

5. **è§¦å‘å¯¼å‡ºä»»åŠ¡**
   ä½¿ç”¨ `curl` æˆ– API å·¥å…·å‘ `http://localhost:8775/ir-message/export` å‘é€ä¸€ä¸ª `POST` è¯·æ±‚:

   ```bash
   curl -X POST http://localhost:8775/ir-message/export \
   -H "Content-Type: application/json" \
   -d '{
         "fileName": "example",
         "exportParams": {
           "totalCount": 500000,
           "sheetRowNumber": 100000,
           "pageRowNumber": 10000,
           "processAttachments": true,
           "attachmentProcessMode": "DEFERRED"
         }
       }'
   ```

   å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ å°†æ”¶åˆ°ä¸€ä¸ªåŒ…å« `mainTaskId` çš„ JSON å“åº”ã€‚ç¨åï¼Œæ–‡ä»¶å°†å‡ºç°åœ¨ä½ é…ç½®çš„ MinIO æˆ– OSS ä¸­ã€‚

---

## 5. æ”¹é€ ä¸ºå·±ç”¨ï¼šé›†æˆä½ çš„å¯¼å‡ºä¸šåŠ¡ï¼ˆæ ¸å¿ƒï¼‰

å‡è®¾ä½ éœ€è¦ä¸ºä¸€ä¸ª `product_info` (äº§å“ä¿¡æ¯) è¡¨åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¼å‡ºåŠŸèƒ½ã€‚

### ç¬¬ä¸€æ­¥ï¼šå®šä¹‰ä½ çš„â€œä¸‰ä»¶å¥—â€æ¨¡å‹

åœ¨ `com.jackasher.ageiport.model` åŒ…ä¸‹åˆ›å»ºæ–°åŒ… `product`ï¼Œå¹¶å®šä¹‰ä¸‰ä¸ªæ ¸å¿ƒç±»ï¼š`ProductQuery.java`, `ProductData.java`, `ProductView.java`ã€‚

### ç¬¬äºŒæ­¥ï¼šå®ç°æ•°æ®è®¿é—®å±‚ (Mapper)

åœ¨ `com.jackasher.ageiport.mapper` åŒ…ä¸‹åˆ›å»º `ProductMapper.java` æ¥å£ï¼Œç»§æ‰¿ `BaseMapper<ProductData>`ã€‚

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºæ ¸å¿ƒä¸šåŠ¡å¤„ç†å™¨ (Processor)

è¿™æ˜¯ä½ å®ç°**æ ¸å¿ƒä¸šåŠ¡é€»è¾‘**çš„åœ°æ–¹ã€‚åœ¨ `com.jackasher.ageiport.processer` åŒ…ä¸‹åˆ›å»º `ProductExportProcessor.java`ã€‚

> **æ³¨æ„**ï¼š`Processor` ä¸æ˜¯ Spring Beanï¼Œä¸èƒ½ `@Resource` æ³¨å…¥ã€‚è¯·ä½¿ç”¨é¡¹ç›®æä¾›çš„ `SpringContextUtil.getBean(...)` æ¥è·å– Mapper æˆ–å…¶ä»– Serviceã€‚

**æ¨¡æ¿å‚è€ƒ `IrMessageExportProcessor.java`ï¼Œä½ éœ€è¦å®ç°çš„å…³é”®æ–¹æ³•ï¼š**

-   `totalCount()`: è®¡ç®—æ€»æ•°æ®é‡ï¼Œåœ¨ä¸»èŠ‚ç‚¹æ‰§è¡Œã€‚
-   `queryData()`: åˆ†é¡µæŸ¥è¯¢æ•°æ®ï¼Œåœ¨å­ä»»åŠ¡èŠ‚ç‚¹å¹¶è¡Œæ‰§è¡Œã€‚
-   `convert()`: æ¨¡å‹è½¬æ¢ï¼Œåœ¨è¿™é‡Œå¯ä»¥è°ƒç”¨ä½ çš„ä¸šåŠ¡æœåŠ¡è¿›è¡Œå¤æ‚çš„æ•°æ®å¤„ç†æˆ–**å‘èµ·åå¤„ç†ä»»åŠ¡**ã€‚

### ç¬¬å››æ­¥ï¼šæ³¨å†Œä½ çš„å¤„ç†å™¨ (SPI)

æ‰“å¼€ `resources/META-INF/ageiport/com.alibaba.ageiport.processor.core.Processor` æ–‡ä»¶ï¼Œ**æ·»åŠ æ–°çš„ä¸€è¡Œ**ï¼š

```properties
# æ ¼å¼ï¼šæ³¨è§£ä¸­çš„code = ä½ çš„å¤„ç†å™¨çš„å®Œæ•´ç±»è·¯å¾„
ProductExportProcessor=com.jackasher.ageiport.processer.ProductExportProcessor
```

### ç¬¬äº”æ­¥ï¼šæš´éœ² API æ¥å£ (Controller)

åœ¨ `com.jackasher.ageiport.controller` åŒ…ä¸‹åˆ›å»º `ProductExportController.java`ï¼Œå‚ç…§ `IrMessageExportController` å®ç°å³å¯ã€‚

---

## 6. é«˜çº§å®šåˆ¶ï¼šç©è½¬åå¤„ç†ä¸å¤š Sheet

-   **å¤š Sheet å¯¼å‡º**: å‚è€ƒ `IrMessageExportProcessor` ä¸­å¯¹ `getHeaders` å’Œ `group` æ–¹æ³•çš„é‡å†™ã€‚é€šè¿‡ä¸ºè¡¨å¤´è®¾ç½®ä¸åŒçš„ `groupIndex`ï¼Œå¯ä»¥åŠ¨æ€åœ°å°†æ•°æ®åˆ†é…åˆ°ä¸åŒçš„ Sheet ä¸­ã€‚
-   **ä»»åŠ¡å›è°ƒ**: ä¿®æ”¹ `com.jackasher.ageiport.callback.MainTaskCallback.java` ä¸­çš„æ–¹æ³•ï¼Œå¯ä»¥å®ç°ä»»åŠ¡æˆåŠŸ/å¤±è´¥æ—¶å‘é€é‚®ä»¶ã€é’‰é’‰é€šçŸ¥ã€æ›´æ–°ä¸šåŠ¡æ•°æ®åº“ç­‰é€»è¾‘ã€‚
-   **è‡ªå®šä¹‰åå¤„ç†ä¸šåŠ¡**:
    1.  åœ¨ `AttachmentProcessMode` æšä¸¾ä¸­æ·»åŠ ä½ çš„æ–°æ¨¡å¼ã€‚
    2.  åœ¨ `AttachmentProcessingService` æ¥å£å’Œå®ç°ä¸­æ·»åŠ ä½ çš„æ–°ä¸šåŠ¡æ–¹æ³•ã€‚
    3.  åœ¨ `AttachmentProcessUtil` ä¸­æ³¨å†Œä½ çš„æ–°æ¨¡å¼å’Œå¯¹åº”çš„å¤„ç†æ–¹æ³•ã€‚
    4.  æœ€åï¼Œåœ¨ä½ çš„ `Processor#convert` æ–¹æ³•ä¸­è°ƒç”¨ `AttachmentProcessUtil.processAttachments` å³å¯ã€‚
-   **æœ€ç»ˆæ–‡ä»¶èšåˆ**ï¼šæœ¬æ¨¡æ¿çš„ `MainTaskCallback` é»˜è®¤å®ç°äº†åœ¨ä»»åŠ¡æˆåŠŸåï¼Œå°†ä¸»æ–‡ä»¶å’Œæ‰€æœ‰é™„ä»¶èšåˆæ‰“åŒ…çš„é€»è¾‘ã€‚æ‚¨å¯ä»¥é€šè¿‡ä¿®æ”¹ `AggregationService` æ¥å®šåˆ¶æ‰“åŒ…ç­–ç•¥ã€‚

## 7. é¡¹ç›®ç»“æ„è§£æ

```
distributed-export-client
â””â”€â”€ src/main
    â”œâ”€â”€ java/com/jackasher/ageiport
    â”‚   â”œâ”€â”€ callback/          # âœ… ä»»åŠ¡å›è°ƒé€»è¾‘ (å¯ä¿®æ”¹)
    â”‚   â”œâ”€â”€ config/            # å¹³å°å±‚é…ç½® (ä¸€èˆ¬æ— éœ€ä¿®æ”¹)
    â”‚   â”œâ”€â”€ controller/        # âœ… APIæ¥å£ (æ·»åŠ ä½ çš„Controller)
    â”‚   â”œâ”€â”€ listener/          # âœ… åˆ†å¸ƒå¼äº‹ä»¶ç›‘å¬å™¨ (DEFERREDæ¨¡å¼æ ¸å¿ƒ)
    â”‚   â”œâ”€â”€ mapper/            # âœ… MyBatis Mapperæ¥å£ (æ·»åŠ ä½ çš„Mapper)
    â”‚   â”œâ”€â”€ model/             # âœ… æ•°æ®æ¨¡å‹ (æ·»åŠ ä½ çš„Query, Data, View)
    â”‚   â”œâ”€â”€ mq/                # âœ… MQç”Ÿäº§è€…å’Œæ¶ˆè´¹è€… (MQæ¨¡å¼æ ¸å¿ƒ)
    â”‚   â”œâ”€â”€ processer/         # âœ… æ ¸å¿ƒå¤„ç†å™¨ (æ·»åŠ ä½ çš„Processor)
    â”‚   â”œâ”€â”€ service/           # âœ… ä¸šåŠ¡æœåŠ¡ (æ·»åŠ ä½ çš„ä¸šåŠ¡é€»è¾‘)
    â”‚   â””â”€â”€ utils/             # ä¸šåŠ¡/å¹³å°å·¥å…·ç±»
    â””â”€â”€ resources
        â”œâ”€â”€ mapper/            # âœ… MyBatis XMLæ–‡ä»¶
        â””â”€â”€ META-INF/ageiport/ # âœ… SPIé…ç½®æ–‡ä»¶ (åœ¨è¿™é‡Œæ³¨å†Œä½ çš„Processorå’ŒListener)
```