# Kafka å¤§æ¶ˆæ¯é—®é¢˜è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æè¿°

é”™è¯¯ä¿¡æ¯ï¼š
```
org.apache.kafka.common.errors.RecordTooLargeException: The message is 4480999 bytes when serialized which is larger than 1048576, which is the value of the max.request.size configuration.
```

**é—®é¢˜åŸå› ï¼š**
- é™„ä»¶ä»»åŠ¡æ¶ˆæ¯åºåˆ—åŒ–åçº¦ä¸º 4.4MB
- Kafka é»˜è®¤çš„ `max.request.size` é™åˆ¶ä¸º 1MB
- æ¶ˆæ¯è¶…è¿‡äº†é»˜è®¤å¤§å°é™åˆ¶

## è§£å†³æ–¹æ¡ˆ

æˆ‘ä»¬æä¾›äº†**ä¸¤ç§è§£å†³æ–¹æ¡ˆ**æ¥å¤„ç†å¤§æ¶ˆæ¯é—®é¢˜ï¼š

### æ–¹æ¡ˆä¸€ï¼šå¢åŠ  Kafka æ¶ˆæ¯å¤§å°é™åˆ¶ âœ…

#### 1. æœåŠ¡å™¨ç«¯é…ç½® (docker-compose-kafka.yml)
```yaml
environment:
  # æ”¯æŒå¤§æ¶ˆæ¯é…ç½®
  KAFKA_MESSAGE_MAX_BYTES: 10485760        # 10MB
  KAFKA_REPLICA_FETCH_MAX_BYTES: 10485760  # 10MB  
  KAFKA_SOCKET_REQUEST_MAX_BYTES: 104857600 # 100MB
```

#### 2. ç”Ÿäº§è€…é…ç½® (KafkaConfig.java)
```java
// æ¶ˆæ¯å¤§å°é…ç½® - æ”¯æŒå¤§æ¶ˆæ¯
configProps.put(ProducerConfig.MAX_REQUEST_SIZE_CONFIG, 10 * 1024 * 1024); // 10MB
configProps.put(ProducerConfig.BUFFER_MEMORY_CONFIG, 64 * 1024 * 1024); // 64MBç¼“å†²åŒº
```

#### 3. æ¶ˆè´¹è€…é…ç½® (KafkaConfig.java)
```java
// æ¶ˆè´¹è€…å¤§æ¶ˆæ¯é…ç½®
props.put(ConsumerConfig.MAX_PARTITION_FETCH_BYTES_CONFIG, 10 * 1024 * 1024); // 10MB
props.put(ConsumerConfig.FETCH_MAX_BYTES_CONFIG, 50 * 1024 * 1024); // 50MB
```

#### 4. åº”ç”¨é…ç½® (application-demo.yml)
```yaml
spring:
  kafka:
    consumer:
      max-partition-fetch-bytes: 10485760  # 10MB
      fetch-max-bytes: 52428800  # 50MB
    producer:
      buffer-memory: 67108864  # 64MB
      max-request-size: 10485760  # 10MB
```

### æ–¹æ¡ˆäºŒï¼šæ¶ˆæ¯åˆ†ç‰‡å¤„ç† âœ…

#### 1. æ¶ˆæ¯åˆ†ç‰‡å™¨ (MessageSplitter.java)
- è‡ªåŠ¨æ£€æµ‹å¤§æ¶ˆæ¯
- å°†å¤§æ¶ˆæ¯åˆ†ç‰‡ä¸ºå¤šä¸ªå°æ¶ˆæ¯
- æ¯ä¸ªåˆ†ç‰‡æœ€å¤šåŒ…å« 1000 æ¡è®°å½•
- æ™ºèƒ½å¤§å°ä¼°ç®—

#### 2. æ™ºèƒ½å‘é€ç­–ç•¥ (KafkaProducerService.java)
```java
// æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦éœ€è¦åˆ†ç‰‡ï¼ˆ5MB é™åˆ¶ï¼‰
if (MessageSplitter.needsSplit(message, 5 * 1024 * 1024)) {
    log.info("æ¶ˆæ¯è¿‡å¤§ï¼Œè¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼ŒSubTaskID: {}", message.getSubTaskId());
    sendMessageWithSplit(message);
} else {
    log.debug("æ¶ˆæ¯å¤§å°é€‚ä¸­ï¼Œç›´æ¥å‘é€ï¼ŒSubTaskID: {}", message.getSubTaskId());
    sendSingleMessage(message);
}
```

## ä½¿ç”¨æ­¥éª¤

### 1. é‡å¯ Kafka ç¯å¢ƒ
```bash
# ä½¿ç”¨æ–°çš„é…ç½®é‡å¯ Kafka
./restart-kafka-with-config.sh
```

### 2. é‡å¯åº”ç”¨ç¨‹åº
```bash
# é‡å¯åº”ç”¨ä»¥åº”ç”¨æ–°çš„é…ç½®
mvn spring-boot:run
```

### 3. éªŒè¯ä¿®å¤æ•ˆæœ
- è§¦å‘é™„ä»¶å¤„ç†ä»»åŠ¡
- æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ¶ˆæ¯å‘é€æˆåŠŸ
- ä½¿ç”¨ Kafka UI ç›‘æ§æ¶ˆæ¯

## é…ç½®è¯¦æƒ…

### æ¶ˆæ¯å¤§å°é™åˆ¶å¯¹æ¯”

| é…ç½®é¡¹ | é»˜è®¤å€¼ | æ–°é…ç½®å€¼ | è¯´æ˜ |
|--------|--------|----------|------|
| max.request.size | 1MB | 10MB | ç”Ÿäº§è€…æœ€å¤§è¯·æ±‚å¤§å° |
| message.max.bytes | 1MB | 10MB | ä¸»é¢˜æœ€å¤§æ¶ˆæ¯å¤§å° |
| max.partition.fetch.bytes | 1MB | 10MB | æ¶ˆè´¹è€…å•æ¬¡è·å–å¤§å° |
| fetch.max.bytes | 50MB | 50MB | æ¶ˆè´¹è€…æ€»è·å–å¤§å° |
| buffer.memory | 32MB | 64MB | ç”Ÿäº§è€…ç¼“å†²åŒº |

### åˆ†ç‰‡ç­–ç•¥

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|----|----|
| åˆ†ç‰‡è§¦å‘é˜ˆå€¼ | 5MB | è¶…è¿‡æ­¤å¤§å°è‡ªåŠ¨åˆ†ç‰‡ |
| æ¯ä¸ªåˆ†ç‰‡æœ€å¤§è®°å½•æ•° | 1000æ¡ | ç¡®ä¿åˆ†ç‰‡å¤§å°åˆç† |
| åˆ†ç‰‡å‘½åè§„åˆ™ | `{subTaskId}_chunk_{åºå·}` | ä¾¿äºè¿½è¸ªå’Œè°ƒè¯• |

## ç›‘æ§å’Œè°ƒè¯•

### 1. æŸ¥çœ‹åˆ†ç‰‡æ—¥å¿—
```bash
grep "åˆ†ç‰‡" logs/application.log
```

### 2. Kafka UI ç›‘æ§
è®¿é—® http://localhost:8080 æŸ¥çœ‹ï¼š
- æ¶ˆæ¯å¤§å°åˆ†å¸ƒ
- åˆ†åŒºåˆ†å¸ƒæƒ…å†µ
- æ¶ˆè´¹æ»åæƒ…å†µ

### 3. ä¸»é¢˜é…ç½®éªŒè¯
```bash
docker exec kafka kafka-topics --describe --topic attachment-processing-topic --bootstrap-server localhost:9092
```

## æ€§èƒ½å½±å“

### ä¼˜åŠ¿
- âœ… æ”¯æŒå¤§æ¶ˆæ¯å¤„ç†
- âœ… è‡ªåŠ¨åˆ†ç‰‡ï¼Œé€æ˜å¤„ç†
- âœ… ä¿æŒæ¶ˆæ¯é¡ºåºï¼ˆåŒä¸€åˆ†åŒºï¼‰
- âœ… é™çº§æœºåˆ¶ï¼ˆå¤±è´¥æ—¶è½¬å¼‚æ­¥ï¼‰

### æ³¨æ„äº‹é¡¹
- ğŸ“Š æ¶ˆæ¯åˆ†ç‰‡ä¼šå¢åŠ å»¶è¿Ÿ
- ğŸ’¾ éœ€è¦æ›´å¤šå†…å­˜å’Œå­˜å‚¨
- ğŸ”§ éœ€è¦åˆç†é…ç½®åˆ†åŒºæ•°é‡
- ğŸ“ˆ ç›‘æ§æ¶ˆè´¹è€…å¤„ç†èƒ½åŠ›

## æ•…éšœå¤„ç†

### 1. å¦‚æœè¿˜æ˜¯å¤±è´¥
```bash
# æ£€æŸ¥ Kafka é…ç½®æ˜¯å¦ç”Ÿæ•ˆ
docker exec kafka kafka-configs --describe --entity-type topics --entity-name attachment-processing-topic --bootstrap-server localhost:9092

# æŸ¥çœ‹ Kafka æ—¥å¿—
docker-compose -f docker-compose-kafka.yml logs kafka
```

### 2. é™çº§ç­–ç•¥
å¦‚æœ Kafka å‘é€å¤±è´¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§ä¸º ASYNC æ¨¡å¼ï¼š
```java
private static void handleKafkaFailure(ProcessContext ctx, Exception e) {
    log.warn("ã€Kafkaæ¨¡å¼ã€‘å‘é€å¤±è´¥ï¼Œå°è¯•é™çº§ä¸ºå¼‚æ­¥æ¨¡å¼å¤„ç†ï¼ŒSubTaskID: {}", ctx.subTaskId);
    try {
        processAsyncMode(ctx);
    } catch (Exception fallbackException) {
        log.error("ã€Kafkaæ¨¡å¼ã€‘é™çº§å¤„ç†ä¹Ÿå¤±è´¥äº†ï¼ŒSubTaskID: {}", ctx.subTaskId, fallbackException);
    }
}
```

## æµ‹è¯•éªŒè¯

### 1. æµ‹è¯•å¤§æ¶ˆæ¯
```bash
# åˆ›å»ºåŒ…å«å¤§é‡æ•°æ®çš„å¯¼å‡ºä»»åŠ¡
# è§‚å¯Ÿæ—¥å¿—ä¸­çš„åˆ†ç‰‡ä¿¡æ¯
tail -f logs/application.log | grep -E "(åˆ†ç‰‡|chunk|Kafka)"
```

### 2. ç›‘æ§æ¶ˆæ¯
```bash
# ç›‘å¬é™„ä»¶å¤„ç†ä¸»é¢˜
docker exec -it kafka kafka-console-consumer --topic attachment-processing-topic --from-beginning --bootstrap-server localhost:9092
```

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¸¤ç§æ–¹æ¡ˆçš„ç»“åˆä½¿ç”¨ï¼š

1. **æ–¹æ¡ˆä¸€** è§£å†³äº† Kafka é…ç½®é™åˆ¶é—®é¢˜
2. **æ–¹æ¡ˆäºŒ** æä¾›äº†æ™ºèƒ½åˆ†ç‰‡å¤„ç†èƒ½åŠ›
3. **é™çº§æœºåˆ¶** ç¡®ä¿ç³»ç»Ÿå¯é æ€§

ç°åœ¨ç³»ç»Ÿå¯ä»¥å¤„ç†ä»»æ„å¤§å°çš„é™„ä»¶ä»»åŠ¡æ¶ˆæ¯ï¼ŒåŒæ—¶ä¿æŒè‰¯å¥½çš„æ€§èƒ½å’Œå¯é æ€§ã€‚
